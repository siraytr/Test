# Tech Design - Tauri Desktop Backup & Gallery App

## Overview
Native desktop app built with Tauri (Rust backend) and React+Vite frontend. Server exposes REST API (Actix-web) and stores uploads under `/mnt/usb/uploads`.

## Chunked upload strategy
- Client requests `POST /api/upload/init` with metadata (filename, size, checksum optional).
- Server returns `upload_id`, `chunk_size` (default 8 MiB), and upload URL.
- Client uploads numbered chunks to `POST /api/upload/{upload_id}/chunk?index={i}` (or with header `X-Chunk-Index`).
- Server writes each chunk to a temp path `<tmp_dir>/<upload_id>.<index>.part`.
- Server stores receivedChunks mapping in DB.
- On `POST /api/upload/{upload_id}/complete`, server assembles parts in order to a temp file, computes SHA-256, compares with provided checksum (if any), then atomically renames to final path:
  `/mnt/usb/uploads/<YYYY-MM-DD>/<username>/<backup-id>.<ext>` or `.zip` if compressed.

## Checksum approach
- Clients SHOULD compute SHA-256 of entire file (or manifest of chunk checksums) and send on init.
- Server computes SHA-256 during assembly and validates equality.

## Resumability
- Server keeps uploaded chunk indexes in DB; client can query `/api/upload/{upload_id}/status` to get missing chunks.
- Chunks are idempotent: reuploading same index overwrites the `.part` file.

## Streaming & Gallery
- Thumbnails generated by background worker using ffmpeg/libheif/libvips.
- Video streaming uses byte-range requests (`GET /api/backups/{id}/stream` supporting `Range` header).
- Optionally generate HLS segments for adaptive streaming (background job).

## Security
- Passwords hashed with Argon2.
- JWT for auth (short TTL) with refresh tokens.
- Server-side RBAC checks for admin endpoints.
- MIME sniffing using libmagic or server-side detection to verify allowed types.
- Optional ClamAV scanning pipeline before finalization.

## Storage & Atomicity
- Assembly writes to temp file inside same filesystem to allow atomic `rename`.
- Ensure uploads never buffered fully in memory; stream to disk.
- Monitor `/mnt/usb` free space; fail uploads gracefully when low.

## Background worker
- Use a small worker (Rust background thread or separate service) to process thumbnails, HEIC conversion, HLS generation, zipping.
- Worker reads tasks from DB queue and updates metadata on completion.

## Admin/User flows
- Registration -> pending user in DB -> visible in `/api/admin/pending`.
- Default admin created on first run by `scripts/init_admin.sh` which prints credentials and requires password change.

